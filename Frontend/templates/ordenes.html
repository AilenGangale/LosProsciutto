<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Ordenes</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color:#fbd19a;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #FBE9D3;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h1 {
            font-size: 2em;
            color: #ff9fa9;
            text-align: center;
            margin-bottom: 20px;
        }

        h2{
            text-align:center;
            font-size: 1.5em;
        }

        .botones-sabor {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .nuevo-boton {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 20px;
            background-color: #fa8f9f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .nuevo-boton:hover {
            background-color: #ff9fa9;
        }

        .fichas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* Añade espacio entre las fichas */
            justify-content: center; /* Centra las fichas en el contenedor */
        }

        .ficha {
            width: 250px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
        }

        .textTitulo {
            padding: 10px;
            background: #FFEDEB;
            color: #fa8f9f;
            border-bottom: 2px solid #FFBAC4;
            font-size: 18px;
            text-align: center;
        }

        .numeroOrden {
            padding: 10px;
            background: #FFEDEB;
            color: #fa8f9f;
            font-size: 24px;
            text-align: center;
            border-bottom: 2px solid #FFBAC4;
        }

        .barras {
            padding: 0px;
            display: flex;
            flex-direction: column;
        }

        .blanca, .rosa {
            padding: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .blanca {
            background: #FFEDEB;
        }

        .rosa {
            background: #FFBAC4;
            color: #fff;
        }

        .blanca p, .rosa p {
            margin: 0;
            font-size: 14px;
        }
        

        .boton-container {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }
   
        .boton-container .boton-acciones {
            margin: 10px 0;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #e57373;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .boton-acciones:hover {
            background-color: #ef5350; 
        }


        i{
            padding-left: 5px;
        }

        #boton-clientes{
            margin-left:50px;
        }
        #boton-clientes{
            margin-right:50px;
        }

        #clientes{
            padding-left: 5px;

        }
        #cheese{
            color: #FFD700;
            
        }

        #cebolla{
            color:bisque;
        }

        #morron{
            color:rgb(221, 30, 30);
        }

        .footer-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .footer-buttons button {
            font-size: 16px;
            background-color: #fa8f9f;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .footer-buttons button:hover {
            background-color: #ff9fa9;
        }
    </style>
</head>
    <div class="container">
        <h1>Órdenes del Cliente {{ cliente.nombre }}</h1>
        <h2>Tenes $ {{ cliente.plata }}</h2>
        <div class="botones-sabor">
            <button class="nuevo-boton" onclick="crearNuevaOrden(1)">Muzzarella<i class="fa-solid fa-cheese" id="cheese"></i></button>
            <button class="nuevo-boton" onclick="crearNuevaOrden(2)">Fugazzeta<i class="fa-solid fa-stroopwafel" id = "cebolla"></i></button>
            <button class="nuevo-boton" onclick="crearNuevaOrden(3)">Morron<i class="fa-solid fa-bacon" id = "morron" ></i></button>
        </div>
        <div class="fichas-container" id="fichas-container">
            {% if ordenes %}
                {% for orden in ordenes %}
                    <div class="ficha">
                        <div class="textTitulo">Papas Pizza</div>
                        <div class="numeroOrden">{{ orden.orden_id }}</div>
                        <div class="barras">
                            <div class="blanca"><p>Sabor de la Pizza: {{ orden.pizza_sabor }}</p></div>
                            <div class="rosa"><p>Costo Total: {{ orden.costo_total }}</p></div>
                            <div class="blanca"><p>Estado: {{ orden.estado }}</p></div>
                            <div class="rosa"><p>ID de pizza: {{ orden.pizza_id }}</p></div>
                            <div class="blanca"><p>Fecha de Entrega: {{ orden.fecha_entrega }}</p></div>
                        </div>
                        <div class="boton-container">
                            <!-- <button class="boton-acciones">Editar</button> -->
                            <button class="boton-acciones" onclick="eliminarOrden({{ orden.orden_id }})">Cancelar pedido</button>
                            <button class="boton-acciones" onclick="retirarOrden({{ orden.orden_id }}, '{{ orden.fecha_entrega }}')">Retirar</button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No hay órdenes para este cliente.</p>
            {% endif %}
        
    </div>
    <div class="footer-buttons">
        <button class="nuevo-boton" id="boton-clientes" onclick="volverAClientes()"> <i class="fa-solid fa-user-group" id="clientes"></i> Volver a clientes</button>
        <button class="nuevo-boton" id="boton-inicio" onclick="volverAlInicio()"> <i class="fa-solid fa-house" id="home"></i> Volver al inicio</button>
    </div>
<script>
    // Redirige al usuario a la página de clientes (/clientes) cuando se llama a esta función. 
    function volverAClientes(){
        window.location.href = "/clientes";
    }

    // Redirige al usuario a la página de inicio (/) cuando se llama a esta función.
    function volverAlInicio(){
        window.location.href = "/";
    }

    // Extrae el ID del cliente de la URL actual. Divide la URL en partes usando / como separador y busca la posición de clientes para obtener el siguiente segmento, que debería ser el ID del cliente.
    function getClienteIdFromPath() {
        const pathArray = window.location.pathname.split('/');
        const clienteIndex = pathArray.indexOf('clientes');
        if (clienteIndex !== -1 && pathArray.length > clienteIndex + 1) {
            return pathArray[clienteIndex + 1];
        }
        return null;
    }
    
    // Convierte la respuesta de una solicitud fetch en formato JSON.
    function response_received(response) {
        return response.json();
    }

    // Maneja errores de solicitudes fetch. Imprime un mensaje de error y, si hay una respuesta con texto, la muestra en la consola. 
    function request_error(error) {
        console.log("ERROR");
        console.log(error);
        if (error.response) {
            error.response.text().then(text => console.log(text));
        }
    }

    // Muestra una lista de órdenes en la página. Crea elementos div para cada orden y los agrega al contenedor con el ID fichas-container. Si no hay órdenes, muestra un mensaje indicando que no hay órdenes para el cliente.
    function mostrar_ordenes(ordenes) {
        const container = document.getElementById('fichas-container');
        container.innerHTML = ''; // Limpiar el contenedor

        if (ordenes.length > 0) {
            ordenes.forEach(orden => {
                const ficha = document.createElement('div');
                ficha.classList.add('ficha');

                ficha.innerHTML = `
                    <div class="textTitulo">Papas Pizza</div>
                    <div class="numeroOrden">${orden.id}</div>
                    <div class="barras">
                        <div class="blanca"><p>ID de Orden: ${orden.pizza_id}</p></div>
                        <div class="rosa"><p>Costo Total: ${orden.costo_total}</p></div>
                        <div class="blanca"><p>Estado: ${orden.estado}</p></div>
                        <div class="rosa"><p>Fecha de Entrega: ${orden.fecha_entrega}</p></div>
                    </div>
                `;

                container.appendChild(ficha);
            });
        } else {
            container.innerHTML = '<p>No hay órdenes para este cliente.</p>';
        }
    }

    // Realiza una solicitud fetch para obtener las órdenes del cliente con el ID proporcionado. Usa el cliente_id para construir la URL de la solicitud y llama a mostrar_ordenes con la respuesta obtenida.
    function cargar_ordenes_cliente(cliente_id) {
        fetch(`/clientes/${cliente_id}/ordenes`)
            .then(response_received)
            .then(mostrar_ordenes)
            .catch(request_error);
    }

    // Crea una nueva orden para el cliente actual con el número de pizza proporcionado. Realiza una solicitud POST a la URL correspondiente y, si la orden se crea correctamente, recarga la página después de un breve retraso. Muestra un mensaje de error si no se puede crear la orden, por ejemplo, si el cliente no tiene suficiente dinero.
    function crearNuevaOrden(numeroPizza) {
        const clienteId = getClienteIdFromPath();
        if (!clienteId) {
            console.error("El ID del cliente no se pudo obtener.");
            return;
        }

        fetch(`/clientes/${clienteId}/nueva_orden/${numeroPizza}`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error(text || 'Error desconocido');
                    });
                }
            })
            .then(data => {
                if (data.orden) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    console.error("No se pudo crear la orden:", data.mensaje);
                }
            })
            .catch(error => {
                alert("No tenés suficiente dinero.");
                console.error("ERROR:", error);
            });
    }

    // Elimina una orden con el ID proporcionado si el usuario confirma la acción. Realiza una solicitud DELETE para eliminar la orden y recarga la página si la solicitud es exitosa. Muestra un mensaje de error en caso de que la eliminación falle.
    function eliminarOrden(ordenId) {
        if (confirm("¿Estás seguro de que deseas eliminar esta orden?")) {
            fetch(`/ordenes/${ordenId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || 'Error desconocido');
                        });
                    }
                })
                .catch(error => {
                    console.error("ERROR:", error);
                });
        }
    }

    // Intenta retirar una orden si la fecha actual es posterior a la fecha de entrega. Convierte la fechaEntrega a un objeto Date, compara con la fecha actual, y si es apropiado, realiza una solicitud DELETE para retirar la orden. Muestra alertas con mensajes sobre el éxito o fracaso de la operación.
    function retirarOrden(ordenId, fechaEntrega) {
    // Convertir la fecha de entrega a un objeto Date
    const fechaEntregaDate = new Date(fechaEntrega);
    
    // Obtener la fecha actual
    const fechaActual = new Date();

    // Imprimir las fechas para depuración
    console.log("Fecha de Entrega:", fechaEntregaDate);
    console.log("Fecha Actual:", fechaActual);

    // Comparar fechas
    if (fechaActual > fechaEntregaDate) {
        // Si la fecha actual es posterior a la fecha de entrega, proceder con el DELETE
        fetch(`/retirar/${ordenId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.mensaje) {
                    alert(data.mensaje);
                    // Recargar la página para actualizar la vista
                    window.location.reload();
                } else {
                    alert("No se pudo retirar la orden.");
                }
            })
            .catch(error => {
                console.error("ERROR:", error);
                alert("No se pudo retirar la orden.");
            });
    } else {
        // Si la fecha actual no es posterior a la fecha de entrega, mostrar un mensaje
        alert("No se puede retirar la orden antes de la fecha de entrega.");
    }
}

    const cliente_id = getClienteIdFromPath();

    if (cliente_id === null) {
        console.error("El ID del cliente es null. Asegúrate de que la URL contiene el parámetro cliente_id.");
    } else {
        cargar_ordenes_cliente(cliente_id);
    }
</script>
</body>
</html>

</body>
</html>
